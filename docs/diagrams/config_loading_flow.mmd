graph TD
    subgraph Initialization
        A[Instantiate ConfigManager Singleton] --> B[Load DEFAULT_CONFIG];
    end

    subgraph Directory Setup
        B --> C{Determine Config Directory};
        C -- Env Var 'AICHEMIST_CONFIG_DIR' --> D[Use Env Var Path];
        C -- OS Default --> E[Use %APPDATA%/AichemistCodex or ~/.aichemist];
        D --> F[Set Config Path: config_dir / 'config.json'];
        E --> F;
        F --> G{Determine Data Directory};
        G -- Env Var 'AICHEMIST_DATA_DIR' --> H[Use Env Var Path];
        G -- Default --> I[Use PROJECT_ROOT / 'data'];
        H --> J[Config/Data Dirs Ready];
        I --> J;
    end

    subgraph User Config Loading
        J --> K{Check if 'config.json' exists};
        K -- Yes --> L[Read 'config.json'];
        L --> M[Deep Merge with Defaults];
        K -- No --> N[Save Defaults to 'config.json'];
        N --> O[Use Default Config];
        M --> P[User Config Loaded/Merged];
        O --> P;
    end

    subgraph Overrides & Finalization
        P --> Q[Apply AICHEMIST_* Env Overrides];
        Q --> R[Configuration Ready];
        R --> S[Access via get_config / set_config];
    end

    subgraph Notes
        T(Note: Code expects/creates 'config.json', but '.codexconfig' might exist in project root);
    end

    style T fill:#f9f,stroke:#333,stroke-width:2px,color:#000;
