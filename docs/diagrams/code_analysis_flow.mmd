graph TD
    subgraph Entry
        A["Call CodeAnalysisService Method (e.g., analyze_file)"] --> B{Input: File Path or Artifact ID};
    end

    subgraph Artifact Handling
        B -- File Path --> C{"Get Artifact by Path (repository.get_by_path)"};
        B -- Artifact ID --> D{"Get Artifact by ID (repository.get_by_id)"};
        C -- Found --> E{Artifact Exists};
        C -- Not Found --> F[Read File Content];
        F --> G[Create New CodeArtifact];
        G --> H["Save Artifact (repository.save)"];
        H --> I[Use Saved Artifact];
        E -- Content Changed? --> J[Update Content];
        J --> K["Save Artifact (repository.save)"];
        K --> I;
        E -- Content Unchanged --> I;
        D -- Found --> I[Use Found Artifact];
        C -- Error --> X[Raise FileNotFoundError];
        D -- Not Found --> Y[Raise RepositoryError];
    end

    subgraph Analysis Core
        I --> L{"Analyze Content (Depth-based)"};
        L -- Depth 1+ --> M[Basic Analysis: Lines, Size, Type];
        M --> N{Depth >= 2?};
        N -- Yes --> O[Standard Analysis];
        O --> P{"Calculate Complexity (calculate_complexity)"};
        P -- Python File --> Q["Use AST (_calculate_python_complexity)"];
        P -- Other File --> R["Use Basic Method (_calculate_basic_complexity)"];
        Q --> S[Complexity Score];
        R --> S;
        O --> T{"Get Structure (get_structure)"};
        T -- Python File --> U["Use AST (Classes, Functions, Vars)"];
        T -- Other File --> V[Basic/No Structure];
        U --> W[Structure Data];
        V --> W;
        N -- No --> Z[End Standard Analysis];
        S --> Z;
        W --> Z;
        Z --> AA{Depth >= 3?};
        AA -- Yes --> BB[Deep Analysis];
        BB --> CC{"Extract Knowledge (extract_knowledge)"};
        CC -- Python File --> DD["Use AST (Docstrings, Funcs, Classes)"];
        CC -- Other File --> EE["Extract Comments (_extract_comments)"];
        DD --> FF[Knowledge Items];
        EE --> FF;
        BB --> GG{"Find Dependencies (find_dependencies)"};
        GG --> HH[Call repository.get_dependencies];
        HH --> II[Dependency Artifacts];
        AA -- No --> JJ[End Deep Analysis];
        FF --> JJ;
        II --> JJ;
    end

    subgraph Output
        M --> KK[Combine Results];
        Z --> KK;
        JJ --> KK;
        KK --> LL[Return Analysis Dictionary];
        X --> LL;
        Y --> LL;
    end

    style G fill:#lightgreen,stroke:#333,stroke-width:1px
    style H fill:#lightgreen,stroke:#333,stroke-width:1px
    style K fill:#lightgreen,stroke:#333,stroke-width:1px
